{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "existingLabName": {
        "type": "string"
      },
      "formulaName":{
        "type": "string"    
      },
      "vmOffer":{
        "type": "string",
        "defaultValue": "UbuntuServer"
      },
      "vmPublisher":{
        "type": "string",
        "defaultValue": "Canonical"
      },
      "vmSku":{
        "type": "string",
        "defaultValue": "16.04-LTS"
      },
      "vmSize":{
        "type": "string",
        "defaultValue": "Standard_D2"
      },
      "ubunturepositoryName":{
        "type": "string",
        "defaultValue": "DTL_AI"
      },
      "userName": {
        "type": "string",
        "defaultValue": "avishay"
      },
      "password": {
        "type": "securestring",
        "defaultValue": "[[[avishay-password]]"
      },
      "Apt-Get_packages": {
        "type": "string",
        "defaultValue": "xfce4 xrdp"
      },
      "Apt-Get_update": {
        "type": "string",
        "defaultValue": "true"
      },
      "Apt-Get_options": {
        "type": "string",
        "defaultValue": ""
      },
      "Apt-Get1_packages": {
        "type": "string",
        "defaultValue": "google-chrome-stable"
      },
      "Apt-Get1_update": {
        "type": "string",
        "defaultValue": "true"
      },
      "Apt-Get1_options": {
        "type": "string",
        "defaultValue": ""
      },
      "Apt-Get11_packages": {
        "type": "string",
        "defaultValue": "build-essential checkinstall libreadline-gplv2-dev libncursesw5-dev libssl-dev libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev"
      },
      "Apt-Get11_update": {
        "type": "string",
        "defaultValue": "true"
      },
      "Apt-Get11_options": {
        "type": "string",
        "defaultValue": ""
      }
    },
    "variables": {
      "labVirtualNetworkName": "[concat('Dtl', parameters('existingLabName'))]",
      "labSubnetName": "[concat(variables('labVirtualNetworkName'), 'Subnet')]",
      "labVirtualNetworkId": "[concat('/virtualnetworks/', variables('labVirtualNetworkName'))]",
      "ostype": "linux", 
      "publicrepositoryName": "public repo",
      "artifactsFolder": "artifacts"
    },
    "resources": [
      {
          "type": "microsoft.devtestlab/labs/formulas",
          "name": "[concat(parameters('existingLabName'), '/', parameters('formulaName'))]",
          "location": "[resourceGroup().location]",
          "apiversion": "2017-04-26-preview",
          "properties": {
            "description": "Formula for Windows VM.",
            "ostype": "[variables('ostype')]",
            "formulacontent": {
              "properties": {
                "size": "[parameters('vmSize')]",
                "username": "",
                "password": "",
                "labsubnetname": "[variables('labSubnetName')]",
                "labvirtualnetworkid": "[variables('labVirtualNetworkId')]",
                "artifacts": [
                    {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'linux-apt-package')]",
                        "parameters": [
                          {
                            "name": "packages",
                            "value": "[parameters('Apt-Get_packages')]"
                          },
                          {
                            "name": "update",
                            "value": "[parameters('Apt-Get_update')]"
                          },
                          {
                            "name": "options",
                            "value": "[parameters('Apt-Get_options')]"
                          }
                        ]
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuDesktop')]"
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuChrome')]"
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'linux-apt-package')]",
                        "parameters": [
                          {
                            "name": "packages",
                            "value": "[parameters('Apt-Get1_packages')]"
                          },
                          {
                            "name": "update",
                            "value": "[parameters('Apt-Get1_update')]"
                          },
                          {
                            "name": "options",
                            "value": "[parameters('Apt-Get1_options')]"
                          }
                        ]
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'linux-apt-package')]",
                        "parameters": [
                          {
                            "name": "packages",
                            "value": "[parameters('Apt-Get11_packages')]"
                          },
                          {
                            "name": "update",
                            "value": "[parameters('Apt-Get11_update')]"
                          },
                          {
                            "name": "options",
                            "value": "[parameters('Apt-Get11_options')]"
                          }
                        ]
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuPython27')]"
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuPython352')]"
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuUmake')]"
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuPyCharm')]"
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuWebStorm')]"
                      },
                      {
                        "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), concat('/artifactsources/', parameters('ubunturepositoryName')), '/', variables('artifactsFolder'), 'UbuntuVSCode')]"
                      }
                ],
                "galleryimagereference": {
                  "offer": "[parameters('vmOffer')]",
                  "publisher": "[parameters('vmPublisher')]",
                  "sku": "[parameters('vmSku')]",
                  "ostype": "[variables('ostype')]",
                  "version": "latest"
                }
              }
            }
          }
        }
      ],   
    "outputs": {
      "formulaId": {
        "type": "string",
        "value": "[resourceId('Microsoft.DevTestLab/labs/formulas', parameters('existingLabName'), parameters('formulaName'))]"
      }
    }
  }